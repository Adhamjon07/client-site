<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Abror CRM</title>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Arial, sans-serif;
      background:#f4f7fb;color:#222;
    }
    header{
      display:flex;justify-content:space-between;align-items:center;
      padding:15px 30px;background:#2b6cb0;color:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }
    header h1{margin:0;font-size:22px;}
    .btn{
      background:#fff;color:#2b6cb0;border:none;
      padding:8px 14px;border-radius:6px;font-weight:bold;
      cursor:pointer;
    }
    .btn:hover{background:#e2e8f0;}
    main{padding:20px;max-width:900px;margin:0 auto;}
    h2{text-align:center;margin-top:0;}
    .client-card{
      background:#fff;border-radius:8px;padding:15px;margin-bottom:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);transition:transform .1s ease;
    }
    .client-card:hover{transform:scale(1.01);}
    .card-actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;}
    .btn-small{padding:5px 8px;font-size:13px;}
    .search-box{text-align:center;margin-bottom:15px;}
    .search-box input{
      width:80%;max-width:400px;padding:8px;border-radius:6px;
      border:1px solid #ccc;font-size:15px;
    }
    .profit-box{
      background:#fff;border-radius:10px;padding:15px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);margin-top:25px;
    }
    .profit-box h3{text-align:center;margin:0 0 10px;}
    .profit-stats{display:flex;justify-content:space-around;flex-wrap:wrap;text-align:center;}
    .profit-stats div{margin:8px 0;}
    .modal-bg{
      position:fixed;inset:0;background:rgba(0,0,0,0.5);
      display:none;align-items:center;justify-content:center;z-index:1000;
    }
    .modal{
      background:#fff;padding:20px;border-radius:10px;width:100%;max-width:500px;
      box-shadow:0 4px 20px rgba(0,0,0,0.2);max-height:90vh;overflow-y:auto;
    }
    .modal h3{text-align:center;margin-top:0;}
    .field{margin-bottom:10px;display:flex;flex-direction:column;}
    .field label{font-weight:bold;margin-bottom:4px;}
    .field input,.field textarea{
      padding:8px;border-radius:5px;border:1px solid #ccc;font-size:14px;
    }
    .modal-actions{
      display:flex;justify-content:flex-end;gap:10px;margin-top:10px;flex-wrap:wrap;
    }
    .btn-secondary{background:#e2e8f0;color:#111;}
    .details p{margin:6px 0;}
  </style>
</head>
<body>

  <header>
    <h1>Abror CRM</h1>
    <button class="btn" id="openModalBtn">–°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
  </header>

  <main>
    <h2>–ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ (–∏–º—è, —Ñ–∞–º–∏–ª–∏—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –º–∞—Ä–∫–∞)">
    </div>

    <div id="clientList"></div>
    <p id="noClientsMsg" style="text-align:center;color:#555;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.</p>

    <div class="profit-box">
      <h3>üìä –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
      <div class="profit-stats">
        <div><b>Bugungi foyda:</b><br><span id="todayProfit">0</span> so'm</div>
        <div><b>Oylik foyda:</b><br><span id="monthProfit">0</span> so'm</div>
        <div><b>Umumiy foyda:</b><br><span id="totalProfit">0</span> so'm</div>
      </div>
    </div>
  </main>

  <!-- Modal: Create/Edit Client -->
  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <h3 id="modalTitle">–°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</h3>
      <form id="clientForm">
        <div class="field"><label>–ò–º—è:</label><input type="text" id="nameInput" required /></div>
        <div class="field"><label>–§–∞–º–∏–ª–∏—è:</label><input type="text" id="surnameInput" required /></div>
        <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω:</label><input type="text" id="phoneInput" required /></div>
        <div class="field"><label>–ú–∞—Ä–∫–∞:</label><input type="text" id="brandInput" required /></div>
        <div class="field"><label>–ü—Ä–æ–±–ª–µ–º–∞:</label><textarea id="problemInput" rows="2" required></textarea></div>
        <div class="field"><label>IMEI 1:</label><input type="text" id="imei1Input" /></div>
        <div class="field"><label>IMEI 2:</label><input type="text" id="imei2Input" /></div>
        <div class="field"><label>–°—É–º–º–∞ (so'm):</label><input type="number" id="sumInput" required /></div>
        <div class="field"><label>–†–∞—Å—Ö–æ–¥ (so'm):</label><input type="number" id="expenseInput" required /></div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" class="btn btn-secondary" id="printBtn">–ü–µ—á–∞—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Details -->
  <div class="modal-bg" id="detailsBg">
    <div class="modal">
      <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
      <div class="details" id="detailsContent"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="closeDetailsBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'abror_clients_v11';

    const openModalBtn = document.getElementById('openModalBtn');
    const modalBg = document.getElementById('modalBg');
    const cancelBtn = document.getElementById('cancelBtn');
    const clientForm = document.getElementById('clientForm');
    const clientList = document.getElementById('clientList');
    const noClientsMsg = document.getElementById('noClientsMsg');
    const searchInput = document.getElementById('searchInput');
    const printBtn = document.getElementById('printBtn');
    const detailsBg = document.getElementById('detailsBg');
    const detailsContent = document.getElementById('detailsContent');
    const closeDetailsBtn = document.getElementById('closeDetailsBtn');
    const modalTitle = document.getElementById('modalTitle');

    const todayProfitEl = document.getElementById('todayProfit');
    const monthProfitEl = document.getElementById('monthProfit');
    const totalProfitEl = document.getElementById('totalProfit');

    let editIndex = null;

    function readClients() {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : [];
    }
    function writeClients(arr) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function renderClients(filter = '') {
      const arr = readClients();
      clientList.innerHTML = '';
      const filtered = arr.filter(c => {
        const text = (c.name + c.surname + c.phone + c.brand).toLowerCase();
        return text.includes(filter.toLowerCase());
      });
      if (filtered.length === 0) {
        noClientsMsg.style.display = 'block';
      } else {
        noClientsMsg.style.display = 'none';
        filtered.forEach((c, index) => {
          const div = document.createElement('div');
          div.className = 'client-card';
          div.innerHTML = `
            <p><b>${index + 1}. ${c.name} ${c.surname}</b></p>
            <p>–ú–∞—Ä–∫–∞: ${c.brand}</p>
            <p>–¢–µ–ª–µ—Ñ–æ–Ω: ${c.phone}</p>
            <p><small>${new Date(c.date).toLocaleString()}</small></p>
            <div class="card-actions">
              <button class="btn btn-small" onclick="viewClient(${index})">üëÅÔ∏è –°–º–æ—Ç—Ä–µ—Ç—å</button>
              <button class="btn btn-small" onclick="editClient(${index})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn btn-small" onclick="deleteClient(${index})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `;
          clientList.appendChild(div);
        });
      }
      updateProfitStats();
    }

    function openModal() {
      modalTitle.textContent = "–°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞";
      modalBg.style.display = 'flex';
      clientForm.reset();
      editIndex = null;
    }
    function closeModal() {
      modalBg.style.display = 'none';
      clientForm.reset();
      editIndex = null;
    }

    function openDetails(c, index) {
      detailsContent.innerHTML = `
        <p><b>–ö–ª–∏–µ–Ω—Ç ‚Ññ${index + 1}</b></p>
        <p><b>–ò–º—è:</b> ${c.name}</p>
        <p><b>–§–∞–º–∏–ª–∏—è:</b> ${c.surname}</p>
        <p><b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> ${c.phone}</p>
        <p><b>–ú–∞—Ä–∫–∞:</b> ${c.brand}</p>
        <p><b>–ü—Ä–æ–±–ª–µ–º–∞:</b> ${c.problem}</p>
        <p><b>IMEI 1:</b> ${c.imei1 || '-'}</p>
        <p><b>IMEI 2:</b> ${c.imei2 || '-'}</p>
        <p><b>–°—É–º–º–∞:</b> ${c.sum.toLocaleString()} so'm</p>
        <p><b>–†–∞—Å—Ö–æ–¥:</b> ${c.expense.toLocaleString()} so'm</p>
        <p><b>–ü—Ä–∏–±—ã–ª—å:</b> ${(c.sum - c.expense).toLocaleString()} so'm</p>
        <p><b>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</b> ${new Date(c.date).toLocaleString()}</p>
      `;
      detailsBg.style.display = 'flex';
    }
    function closeDetails() { detailsBg.style.display = 'none'; }

    function viewClient(i) {
      const arr = readClients();
      openDetails(arr[i], i);
    }

    function editClient(i) {
      const arr = readClients();
      const c = arr[i];
      openModal();
      modalTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞";
      document.getElementById('nameInput').value = c.name;
      document.getElementById('surnameInput').value = c.surname;
      document.getElementById('phoneInput').value = c.phone;
      document.getElementById('brandInput').value = c.brand;
      document.getElementById('problemInput').value = c.problem;
      document.getElementById('imei1Input').value = c.imei1;
      document.getElementById('imei2Input').value = c.imei2;
      document.getElementById('sumInput').value = c.sum;
      document.getElementById('expenseInput').value = c.expense;
      editIndex = i;
    }

    function deleteClient(i) {
      if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?")) return;
      const arr = readClients();
      arr.splice(i, 1);
      writeClients(arr);
      renderClients();
    }

    printBtn.addEventListener('click', () => window.print());

    clientForm.addEventListener('submit', e => {
      e.preventDefault();
      const client = {
        name: document.getElementById('nameInput').value.trim(),
        surname: document.getElementById('surnameInput').value.trim(),
        phone: document.getElementById('phoneInput').value.trim(),
        brand: document.getElementById('brandInput').value.trim(),
        problem: document.getElementById('problemInput').value.trim(),
        imei1: document.getElementById('imei1Input').value.trim(),
        imei2: document.getElementById('imei2Input').value.trim(),
        sum: +document.getElementById('sumInput').value,
        expense: +document.getElementById('expenseInput').value,
        date: new Date().toISOString()
      };
      const arr = readClients();
      if (editIndex !== null) {
        arr[editIndex] = client;
      } else {
        arr.unshift(client);
      }
      writeClients(arr);
      renderClients();
      closeModal();
      alert('–ö–ª–∏–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
    });

    searchInput.addEventListener('input', e => renderClients(e.target.value));

    openModalBtn.addEventListener('click', openModal);
    cancelBtn.addEventListener('click', closeModal);
    modalBg.addEventListener('click', e => { if (e.target === modalBg) closeModal(); });
    closeDetailsBtn.addEventListener('click', closeDetails);
    detailsBg.addEventListener('click', e => { if (e.target === detailsBg) closeDetails(); });

    function updateProfitStats() {
      const arr = readClients();
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const monthStr = todayStr.slice(0, 7);
      let todayProfit = 0, monthProfit = 0, totalProfit = 0;
      arr.forEach(c => {
        const profit = c.sum - c.expense;
        const dateStr = c.date.split('T')[0];
        if (dateStr === todayStr) todayProfit += profit;
        if (dateStr.startsWith(monthStr)) monthProfit += profit;
        totalProfit += profit;
      });
      todayProfitEl.textContent = todayProfit.toLocaleString();
      monthProfitEl.textContent = monthProfit.toLocaleString();
      totalProfitEl.textContent = totalProfit.toLocaleString();
    }

    document.addEventListener('DOMContentLoaded', () => renderClients());
  </script>
</body>
</html>